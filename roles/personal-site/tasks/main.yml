---
- name: Fetch over Git
  git: repo=https://github.com/meoblast001/meosite.git dest=/var/server/meosite
  become: yes
  become_user: "{{ deploy_user }}"
- name: Create Cabal sandbox
  command: cabal sandbox init
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/.cabal-sandbox
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install Configuration.hs
  copy: src=Configuration.hs dest=/var/server/meosite/Configuration.hs
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install dependencies and build project over Cabal
  shell: cabal update && cabal install --only-dependencies && cabal build
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/dist/build/site/site
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install xelatex and libraries required to compile LaTeX documents
  dnf: name={{ item }} state=present
  become: yes
  with_items:
    - "texlive-collection-fontsrecommended"
    - "texlive-xetex"
    - "texlive-latex"
    - "texlive-babel"
    - "texlive-titlesec"
    - "texlive-moderncv"
    - "texlive-euenc"
    - "fontawesome-fonts"
    - "texlive-fontawesome"
- name: Install coffee-script
  dnf: name=coffee-script state=present
  become: yes
- name: Install ImageMagick
  dnf: name=ImageMagick state=present
  become: yes
- name: Rebuild static site
  shell: LC_ALL=en_US dist/build/site/site rebuild
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/_site/index.html
  become: yes
  become_user: "{{ deploy_user }}"
- name: Deploy static site
  command: dist/build/site/site deploy
  args:
    chdir: /var/server/meosite
    creates: /var/www/meosite/index.html
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install code-graph in crontab
  cron: name=code-graph state=present
  args:
    value: /var/server/meosite/dist/build/code-graph/code-graph meoblast001 /var/www/meosite /home/deploy/error.code-graph.log
    user: deploy
    minute: 0
    hour: 6
  become: yes
