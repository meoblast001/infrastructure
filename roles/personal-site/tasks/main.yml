---
- name: Fetch over Git
  git: repo=https://github.com/meoblast001/meosite.git dest=/var/server/meosite
  become: yes
  become_user: "{{ deploy_user }}"
- name: Create Cabal sandbox
  command: cabal sandbox init
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/.cabal-sandbox
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install Configuration.hs
  copy: src=Configuration.hs dest=/var/server/meosite/Configuration.hs
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install dependencies and build project over Cabal
  shell: cabal update && cabal install --only-dependencies && cabal build
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/dist/build/site/site
  become: yes
  become_user: "{{ deploy_user }}"
- name: Install xelatex (texlive-collection-fontsrecommended, texlive-xetex, texlive-latex, texlive-titlesec)
  dnf: name={{ item }} state=present
  become: yes
  with_items:
    - "texlive-collection-fontsrecommended"
    - "texlive-xetex"
    - "texlive-latex"
    - "texlive-titlesec"
- name: Install coffee-script
  dnf: name=coffee-script state=present
  become: yes
- name: Install ImageMagick
  dnf: name=ImageMagick state=present
  become: yes
- name: Rebuild static site
  command: dist/build/site/site
  args:
    chdir: /var/server/meosite
    creates: /var/server/meosite/_site/index.html
  become: yes
  become_user: "{{ deploy_user }}"
