server {
  listen {{ item.port }};
  {% if item.server_name is defined %}
    server_name {{ item.server_name }};
  {% endif %}

  {% if item.redirect_https is defined and item.redirect_https %}
    rewrite ^ https://$server_name$request_uri? permanent;
  {% endif %}

  {% if item.root_path is defined %}
    location / {
      root {{ item.root_path }};
      index {% if item.index is defined %}{{ item.index }}{% else %}index.html{% endif %};

      {% if item.has_php is defined and item.has_php == True %}
        location ~ \.php$ {
          fastcgi_param REQUEST_METHOD $request_method;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_index index.php;
          fastcgi_pass unix:/var/run/php-fpm/{{ item.file_name }}.sock;
        }
      {% endif %}
    }
  {% endif %}

  {% if item.proxy_pass is defined %}
    location / {
      proxy_pass {{ item.proxy_pass }};

      proxy_http_version 1.1;
      proxy_set_header Host $http_host;
      proxy_set_header Upgrade $http_upgrade;
      proxy_buffering off;
    }
  {% endif %}

  {% if item.additional_params is defined %}
    {% for k, v in item.additional_params.iteritems() %}
      {{ k }} {{ v }};
    {% endfor %}
  {% endif %}
}
